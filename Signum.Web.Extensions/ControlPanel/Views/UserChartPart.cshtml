@using System.Configuration
@using Signum.Entities.ControlPanel
@using Signum.Web.ControlPanel
@using Signum.Entities.DynamicQuery
@using Signum.Entities.Chart
@using Signum.Web.Chart
@using Signum.Engine.Chart
@using Signum.Engine.DynamicQuery
@model PanelPartDN
@Html.ScriptsJs("~/Chart/Scripts/SF_Chart.js",
                "~/Chart/Scripts/SF_Chart_Utils.js",
                "~/scripts/d3.v2.min.js",
                "~/scripts/colorbrewer.js")
@Html.ScriptCss("~/Chart/Content/SF_Chart.css")
@{ 
    var ucPart = (UserChartPartDN)Model.Content;
    UserChartDN uc = ucPart.UserChart;
    ChartRequest request = uc.ToRequest();

    using (var crc = new TypeContext<ChartRequest>(request, "r{0}c{1}".Formato(Model.Row, Model.Column)))
    {
        ResultTable resultTable = ChartLogic.ExecuteChart(request);


    <div id="@crc.Compose("sfChartControl")" class="sf-search-control sf-chart-control" data-prefix="@crc.ControlID">
        <div style="display: none">
            @Html.HiddenRuntimeInfo(crc)
            @Html.Hidden(crc.Compose("sfOrders"), request.Orders.IsNullOrEmpty() ? "" :
                    (request.Orders.ToString(oo => (oo.OrderType == OrderType.Ascending ? "" : "-") + oo.Token.FullKey(), ";") + ";"))
            @{
        ViewData[ViewDataKeys.QueryDescription] = DynamicQueryManager.Current.QueryDescription(request.QueryName);
        ViewData[ViewDataKeys.FilterOptions] = request.Filters.Select(f => new FilterOption { Token = f.Token, Operation = f.Operation, Value = f.Value }).ToList();
            }
            @Html.Partial(Navigator.Manager.FilterBuilderView, crc)
            <div id="@crc.Compose("sfChartBuilderContainer")">
                @Html.Partial(ChartClient.ChartBuilderView, crc)
            </div>
            <script type="text/javascript">
                        $('#@crc.Compose("sfChartBuilderContainer")').chartBuilder($.extend({ prefix: '@crc.ControlID'}, @MvcHtmlString.Create(uc.ToJS())));
            </script>
        </div>
        <div id="@crc.Compose("sfChartContainer")">
            <div class="sf-chart-container" style="display:@(ucPart.ShowData ? "none" : "block")" 
                    data-open-url="@(Url.Action<ChartController>(cc => cc.OpenSubgroup(crc.ControlID)))" 
                    data-fullscreen-url="@(Url.Action<ChartController>(cc => cc.FullScreen(crc.ControlID)))"
                    data-json="@Html.Json(ChartUtils.DataJson(crc.Value, resultTable)).ToString()">
            </div>
        </div>
    </div>
    
        if (ucPart.ShowData)
        {
            ViewData[ViewDataKeys.Results] = resultTable;
            ViewData[ViewDataKeys.Navigate] = false;

            QuerySettings settings = Navigator.QuerySettings(request.QueryName);
            ViewData[ViewDataKeys.Formatters] = resultTable.Columns.Select((c, i) => new { c, i }).ToDictionary(c => c.i, c => settings.GetFormatter(c.c.Column));

            @Html.Partial(ChartClient.ChartResultsTableView, new TypeContext<ChartRequest>(request, "r{0}c{1}".Formato(Model.Row, Model.Column)))
        }
        else
        {
            MvcHtmlString divSelector = MvcHtmlString.Create("#" + crc.Compose("sfChartContainer") + " > .sf-chart-container");
   
            <script type="text/javascript">
                (function () {
                    var $myChart = SF.Chart.getFor('@crc.ControlID');
                    $myChart.reDraw();
                })();
            </script>
        }
        <script type="text/javascript">
            (function () {
                $("#" + SF.compose("@crc.ControlID", "sfFullScreen")).on("mousedown", function (e) {
                    var $myChart = SF.Chart.getFor('@crc.ControlID');
                    $myChart.fullScreen(e);
                });
            })();
        </script>
    }
}
