@using Signum.Web
@using Signum.Web.Extensions.Properties
@using Signum.Entities.DynamicQuery
@using Signum.Engine.DynamicQuery
@using System.Configuration
@using Signum.Entities.Reflection
@using Signum.Entities
@using Signum.Entities.Chart
@using Signum.Web.Chart
@using Signum.Utilities
@using Signum.Engine.Chart
@using (var chart = Html.TypeContext<ChartRequest>())
{
    QueryDescription queryDescription = (QueryDescription)ViewData[ViewDataKeys.QueryDescription];
    if (queryDescription == null)
    {
        queryDescription = DynamicQueryManager.Current.QueryDescription(((UserChartDN)((TypeContext)chart.Parent).UntypedValue).QueryName);
    }

    <table id="@chart.Compose("sfChartBuilder")" class="sf-chart-builder" data-url="@(Url.Action<ChartController>(cc => cc.UpdateChartBuilder(chart.Parent.ControlID)))">
        <tr>
            <td class="ui-widget ui-widget-content ui-corner-all sf-chart-type">
                <div class="ui-widget-header">
                    @typeof(ChartScriptDN).NiceName()
                    @using(var csc = chart.SubContext(c=>c.ChartScript))
                    {
                        @Html.Hidden(csc.Compose("RuntimeInfo"), csc.RuntimeInfo().ToString(), new { @class = "sf-chart-type-value" })
                    }
                    @Html.Hidden(chart.Compose("GroupResults"), chart.Value.GroupResults, new { @class = "sf-chart-group-results" })
                </div>
                @foreach (var group in ChartScriptLogic.Scripts.Value.GroupsOf(4))
                {
                    foreach (var script in group)
                    { 
                        <img src="@Html.Action((Signum.Web.Files.FileController fc)=>fc.DownloadFile(script.Id))"
                         data-related="@script.Id.ToString()" 
                         title="@script.ToString()"/>
                    }
                    <div class="clearall"></div>
                }
            </td>
            <td class="ui-widget ui-widget-content ui-corner-all sf-chart-tokens">
                <div class="ui-widget-header">@Resources.Chart_ChartSettings</div>
                <table>
                    <tr>
                        <th class="sf-chart-token-narrow">@Resources.Chart_Dimension</th>
                        <th class="sf-chart-token-narrow">@Resources.Chart_Group</th>
                        <th class="sf-chart-token-wide">Token</th>
                    </tr>
                    @foreach (var item in chart.TypeElementContext(a=>a.Columns))
	                {
                        @Html.HiddenRuntimeInfo(item)
                        @Html.EmbeddedControl(chart, cr => cr, ec => ec.ViewData[ViewDataKeys.QueryName] = queryDescription.QueryName)
	                }
                    
                </table>
            </td>
        </tr>
    </table>
}